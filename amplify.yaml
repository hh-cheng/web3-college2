version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 22.14.0
        - nvm use 22.14.0
        - curl -fsSL https://get.pnpm.io/install.sh | sh -
        - export PATH="$HOME/.local/share/pnpm:$PATH"
        - export TZ=Asia/Shanghai
        - echo "STORE_PATH=$(pnpm store path)" >> .env
        - export NODE_OPTIONS='--max-old-space-size=7000'
    build:
      commands:
        - env | grep -e CHAIN_ID >> .env.production
        - env | grep -e CHAIN_RPC_URL >> .env.production
        - env | grep -e CHAIN_NAME >> .env.production
        - env | grep -e CHAIN_NATIVE_SYMBOL >> .env.production
        - env | grep -e CHAIN_NATIVE_NAME >> .env.production

        - env | grep -e WEB3_AWS_REGION >> .env.production
        - env | grep -e WEB3_AWS_ACCESS_KEY_ID >> .env.production
        - env | grep -e WEB3_AWS_SECRET_ACCESS_KEY >> .env.production

        - env | grep -e DATABASE_URL >> .env.production
        - env | grep -e DB_USERNAME >> .env.production
        - env | grep -e DB_SECRET_ID >> .env.production
        - env | grep -e DB_NAME >> .env.production
        - env | grep -e RDS_PROXY_HOST >> .env.production
        - env | grep -e DB_CONN_PARAMS >> .env.production
        - env | grep -e DB_PORT >> .env.production

        - env | grep -e R2_ACCESS_KEY >> .env.production
        - env | grep -e R2_SECRET_KEY >> .env.production
        - env | grep -e R2_ENDPOINT >> .env.production
        - env | grep -e R2_BUCKET >> .env.production

        - env | grep -e NODE_TLS_REJECT_UNAUTHORIZED >> .env.production

        - env | grep -e COURSE_MANAGER_ADDRESS >> .env.production
        - env | grep -e YDTOKEN_ADDRESS >> .env.production
        - env | grep -e YDFAUCET_ADDRESS >> .env.production
        - env | grep -e YDETH_SWAP_ADDRESS >> .env.production

        - pnpm install
        - pnpm db:generate
        - pnpm build
        # Clean up unnecessary files to reduce artifact size
        - find .next -name "*.map" -type f -delete || true
        - rm -rf .next/cache .next/trace || true
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - '.next/cache/**/*'
      - '.pnpm-store/**/*'
